---
- name: Demo Playbook for the ansible-runner API
  hosts: localhost
  gather_facts: false
  become: true
  vars:

  tasks:
    - name: Check if module_dir is defined
      ansible.builtin.fail:
        msg: "module_dir not defined"
      when: module_dir is not defined

    - name: Check if module_stage is defined
      ansible.builtin.fail:
        msg: "module_stage not defined"
      when: module_stage is not defined

    - name: Check if {{ module_dir }}/control/{{ module_stage }} exists
      ansible.builtin.stat:
        path: ./{{ module_dir }}/control/{{ module_stage }}.sh
      register: r_control_script

    - name: Check if {{ module_dir }}/node1/{{ module_stage }} exists
      ansible.builtin.stat:
        path: ./{{ module_dir }}/node1/{{ module_stage }}.sh
      register: r_node1_script

    - name: Check if {{ module_dir }}/node2/{{ module_stage }} exists
      ansible.builtin.stat:
        path: ./{{ module_dir }}/node2/{{ module_stage }}.sh
      register: r_node2_script

    - name: Check if {{ module_dir }}/node3/{{ module_stage }} exists
      ansible.builtin.stat:
        path: ./{{ module_dir }}/node3/{{ module_stage }}.sh
      register: r_node3_script

- hosts: control_nodes
  gather_facts: false
  tasks:
    - name: Execute setup.sh if it exists
      when: hostvars.localhost.r_control_script.stat.exists
      ansible.builtin.script:
        cmd:  ./{{ module_dir }}/control/{{ module_stage }}.sh
      ignore_errors: true
      register: r_result

    - name: Write script result to file
      ansible.builtin.copy:
        content: "{{ r_result.stdout }}"
        dest: "{{ job_info_dir }}/script.out"
      when: r_result is defined and job_info_dir is defined

    - name: Output script result
      ansible.builtin.debug:
        var: r_result

    - name: Fail if stage was failed
      ansible.builtin.fail:
        msg: "Stage failed"
      when: r_result.rc != 0